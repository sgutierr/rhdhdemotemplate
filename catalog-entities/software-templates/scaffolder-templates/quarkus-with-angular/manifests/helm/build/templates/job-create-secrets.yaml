apiVersion: batch/v1
kind: Job
metadata:
  name: secret-copy-job
  annotations:
    argocd.argoproj.io/sync-wave: "2"  
spec:
  template:
    spec:
      serviceAccountName: pipeline
      containers:
      - name: secret-copy
        image: registry.redhat.io/openshift4/ose-cli
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
        command:
        - /bin/sh
        - -c
        - |
          GITLAB_TOKEN=$(oc get secret root-user-personal-token -n gitlab-system -o jsonpath='{.data.token}')
          WEBHOOK_PAT=$(oc get secret root-user-personal-token -n gitlab-system -o jsonpath='{.data.secret}')
          oc create secret generic {{ .Values.app.name }}-git-token --from-literal=token=$GITLAB_TOKEN
          oc create secret generic {{ .Values.app.name }}-webhook-secret --from-literal=token=$WEBHOOK_SECRET
      restartPolicy: Never
  backoffLimit: 1